<%- include('partials/header', { title: 'Дашборд', bodyClass: 'page-dashboard', user, path: '/' }) %>

<% const _byZone = (typeof byZone !== 'undefined' && byZone) ? byZone : []; %>

<div class="card">
  <div class="row" style="align-items:center;">
    <div class="field" style="flex: 1 1 420px; min-width: 260px;">
      <h1 style="margin:0 0 4px; font-size: 22px;">Дашборд</h1>
      <div class="muted">Управление доступом</div>
    </div>
    <div class="right" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      <% if (user && user.role === 'admin') { %>
        <a class="btn" href="/logs">Журнал транзита</a>
        <a class="btn" href="/admin/users">Админка</a>
      <% } %>
    </div>
  </div>
</div>

<% if (!_byZone.length) { %>
  <div class="card">
    <div class="muted">У вас пока нет назначенных зон/устройств. Попросите админа добавить доступ.</div>
  </div>
<% } %>

<% _byZone.forEach(z => { %>
  <div class="card">
    <div class="row" style="align-items:center;">
      <div class="field" style="flex: 1 1 420px; min-width: 240px;">
        <h2 style="margin:0 0 4px; font-size: 16px;"><%= z.zoneName %></h2>
        <div class="muted" style="font-size:12px;"><%= z.zoneId %></div>
      </div>
      <span class="badge">Зона</span>
    </div>

    <div class="spacer"></div>

    <div class="row">
      <% (z.devices || []).forEach(d => { %>
        <button class="btn btn-primary" type="button"
          style="flex: 1 1 260px; min-width: 240px;"
          data-device-id="<%= d.id %>">
          <span style="display:flex; align-items:center; justify-content:space-between; gap:10px; width:100%;">
            <span style="text-align:left; min-width:0;">
              <div style="font-weight:700; line-height:1.2;"><%= d.name %></div>
              <div class="muted" style="font-size:12px; overflow:hidden; text-overflow:ellipsis;"><%= d.id %></div>
            </span>
            <span style="opacity:.75; font-size:18px;">›</span>
          </span>
        </button>
      <% }) %>
    </div>
  </div>
<% }) %>

<script>
  async function openDevice(id, btn){
    const oldHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span style="display:flex; width:100%; justify-content:center;">Открываю…</span>';
    try{
      const r = await fetch('/api/open/' + encodeURIComponent(id), { method:'POST' });
      const j = await r.json().catch(()=>({}));
      if(!r.ok || !j.ok) throw new Error(j.error || 'Ошибка');
      btn.innerHTML = '<span style="display:flex; width:100%; justify-content:center;">Открыто ✓</span>';
      setTimeout(()=>{ btn.innerHTML = oldHtml; }, 900);
    }catch(e){
      alert(e.message || 'Ошибка');
      btn.innerHTML = oldHtml;
    }finally{
      btn.disabled = false;
    }
  }
  document.querySelectorAll('[data-device-id]').forEach(btn=>{
    btn.addEventListener('click', ()=>openDevice(btn.dataset.deviceId, btn));
  });
</script>

<%- include('partials/footer') %>
