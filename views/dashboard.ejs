<%- include('partials/header', { title, bodyClass, user }) %>

<div class="d-flex flex-wrap gap-2 align-items-center justify-content-between mb-3">
  <div>
    <h1 class="h4 mb-0">Parking GIT</h1>
    <div class="text-muted small">Управление доступом</div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-soft" href="/logs">Журнал транзита</a>
    <% if (user && user.role === 'admin') { %>
      <a class="btn btn-soft" href="/admin/users">Админка</a>
    <% } %>
  </div>
</div>

<% if (!byZone || !byZone.length) { %>
  <div class="card card-glass p-3">
    <div class="text-muted">У вас пока нет назначенных зон/устройств. Попросите админа добавить доступ.</div>
  </div>
<% } %>

<div class="row g-3">
  <% (byZone || []).forEach(z => { %>
    <div class="col-12">
      <div class="card card-glass">
        <div class="card-header bg-transparent border-0 pb-0">
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <div class="h6 mb-0"><%= z.zoneName %></div>
              <div class="small text-muted text-wrap"><%= z.zoneId %></div>
            </div>
            <span class="badge badge-soft">Зона</span>
          </div>
        </div>
        <div class="card-body">
          <div class="row g-2">
            <% (z.devices || []).forEach(d => { %>
              <div class="col-12 col-md-6 col-lg-4">
                <button class="btn btn-zone w-100" type="button" data-device-id="<%= d.id %>">
                  <div class="d-flex align-items-center justify-content-between">
                    <div class="text-start">
                      <div class="fw-semibold"><%= d.name %></div>
                      <div class="small text-muted text-wrap"><%= d.id %></div>
                    </div>
                    <span class="chev">›</span>
                  </div>
                </button>
              </div>
            <% }) %>
          </div>
        </div>
      </div>
    </div>
  <% }) %>
</div>

<script>
  async function openDevice(id, btn){
    btn.disabled = true;
    btn.classList.add('loading');
    try{
      const r = await fetch(`/api/open/${encodeURIComponent(id)}`, { method:'POST', headers:{'Content-Type':'application/json'} });
      const j = await r.json().catch(()=>({}));
      if(!r.ok || !j.ok) throw new Error(j.error || 'Ошибка');
      btn.classList.add('ok');
      setTimeout(()=>btn.classList.remove('ok'), 900);
    }catch(e){
      alert(e.message || 'Ошибка');
    }finally{
      btn.disabled = false;
      btn.classList.remove('loading');
    }
  }

  document.querySelectorAll('[data-device-id]').forEach(btn=>{
    btn.addEventListener('click', ()=>openDevice(btn.dataset.deviceId, btn));
  });
</script>

<%- include('partials/footer') %>
