<%- include('partials/header', { title: 'Панель управления', user: (typeof user !== 'undefined' ? user : null), bodyClass: (typeof bodyClass !== 'undefined' ? bodyClass : 'dashboard') }) %>

<%
  const safeUser = (typeof user !== 'undefined' && user) ? user : null;
  const safeZones = (typeof zones !== 'undefined' && Array.isArray(zones)) ? zones : [];
  const selected = (typeof selectedZone !== 'undefined' && selectedZone) ? String(selectedZone) : '';

  // Показываем либо выбранную зону, либо все
  const shownZones = selected ? safeZones.filter(z => String(z.id) === selected) : safeZones;
%>

<div class="d-flex align-items-end justify-content-between mb-3">
  <div>
    <h2 class="mb-1">Панель управления</h2>
    <div class="muted">
      <%= safeUser ? (safeUser.fio || safeUser.id) : 'Гость' %>
      <% if (safeUser && safeUser.role) { %>
        · <span class="badge"><%= safeUser.role %></span>
      <% } %>
    </div>
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <div class="muted">Фильтр по зоне</div>
      <div class="chips">
        <a class="chip <%= selected ? '' : 'active' %>" href="/">Все зоны</a>
        <% for (const z of safeZones) { %>
          <a class="chip <%= (selected === String(z.id)) ? 'active' : '' %>" href="/?zone=<%= encodeURIComponent(z.id) %>">
            <%= z.name || z.id %>
          </a>
        <% } %>
      </div>
    </div>
  </div>
</div>

<% if (!shownZones.length) { %>
  <div class="alert alert-warning">
    Нет доступных устройств. Проверьте зоны доступа у пользователя (users.zones) и наличие устройств в таблице devices.
  </div>
<% } %>

<div class="grid">
  <% for (const z of shownZones) { %>
    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="h6 mb-0"><%= z.name || z.id || 'Без зоны' %></div>
            <div class="muted" style="margin-top:4px;">
              Устройств: <%= (z.devices ? z.devices.length : 0) %>
            </div>
          </div>
        </div>

        <div class="device-grid" style="margin-top:14px;">
          <% for (const d of (z.devices || [])) { %>
            <button
              class="btn <%= d.is_active === false ? 'btn-secondary' : 'btn-primary' %>"
              style="width:100%;"
              <%= d.is_active === false ? 'disabled' : '' %>
              onclick="openDevice('<%= d.id %>')"
            >
              <%= d.name || d.id %>
            </button>
          <% } %>
        </div>
      </div>
    </div>
  <% } %>
</div>

<script>
async function openDevice(id) {
  try {
    const r = await fetch('/api/open', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id })
    });
    const data = await r.json().catch(() => ({}));
    if (!r.ok) {
      alert((data && data.error) ? data.error : 'Ошибка');
      return;
    }
    alert('✅ Отправлено');
  } catch (e) {
    alert('Ошибка сети');
  }
}
</script>

<%- include('partials/footer') %>
