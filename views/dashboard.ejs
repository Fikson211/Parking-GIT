<%- include('partials/header', { title: 'Дашборд', bodyClass: 'page-dashboard', user, path: '/' }) %>

<% const _byZone = (typeof byZone !== 'undefined' && byZone) ? byZone : []; %>

<div class="card">
  <div class="row" style="align-items:flex-start;">
    <div class="field" style="flex: 1 1 420px; min-width: 260px;">
      <h1 style="margin:0 0 4px; font-size: 22px;">Дашборд</h1>
      <div class="muted">Выберите зону — затем откройте нужное устройство</div>
    </div>
    <div class="right page-actions" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      <% if (user && user.role === 'admin') { %>
        <a class="btn btn-soft" href="/logs">Журнал транзита</a>
        <a class="btn btn-soft" href="/admin/users">Админка</a>
      <% } %>
    </div>
  </div>
</div>

<% if (!_byZone.length) { %>
  <div class="card">
    <div class="muted">У вас пока нет назначенных зон/устройств. Попросите админа добавить доступ.</div>
  </div>
<% } else { %>
  <div class="row" style="gap:12px; align-items:stretch;">
    <div class="field" style="flex:1 1 320px; min-width:260px;">
      <div class="card dashboard-action-card" id="openZonesSheetCard" role="button" tabindex="0">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
          <div>
            <h2 class="h6 mb-0">Зоны</h2>
            <div class="text-muted small">Открыть список зон в боковой шторке</div>
          </div>
          <button class="btn btn-soft btn-sm" type="button" id="openZonesSheetBtn">Открыть</button>
        </div>
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
          <div class="text-muted small" id="zonesCountLabel"><%= _byZone.length %> шт.</div>
          <div class="text-muted small" id="selectedZoneLabel">Зона не выбрана</div>
        </div>
      </div>
    </div>

    <div class="field" style="flex:1 1 320px; min-width:260px;">
      <div class="card dashboard-action-card" id="openDevicesSheetCard" role="button" tabindex="0">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
          <div>
            <h2 class="h6 mb-0">Устройства</h2>
            <div class="text-muted small">Устройства выбранной зоны открываются в шторке</div>
          </div>
          <button class="btn btn-soft btn-sm" type="button" id="openDevicesSheetBtn">Открыть</button>
        </div>
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
          <div class="text-muted small" id="devicesCountLabel">Сначала выберите зону</div>
          <div class="text-muted small">Без прокрутки страницы</div>
        </div>
      </div>
    </div>
  </div>

  <div class="sheet-backdrop" id="dashboardSheetBackdrop" hidden></div>

  <aside class="dashboard-sheet" id="zonesSheet" aria-hidden="true">
    <div class="dashboard-sheet__head">
      <div>
        <div class="text-muted small">Доступные зоны</div>
        <h2 class="h6 mb-0">Зоны</h2>
      </div>
      <button class="btn btn-ghost btn-sm" type="button" data-close-sheet>Закрыть</button>
    </div>
    <div class="dashboard-sheet__body">
      <div class="text-muted small" style="margin-bottom:8px;">Нажмите на зону, чтобы открыть список устройств</div>
      <div class="zone-grid" id="zoneGrid">
        <% _byZone.forEach((z, idx) => { %>
          <button type="button" class="zone-tile" data-zone-index="<%= idx %>">
            <div class="zone-title"><%= z.zoneName %></div>
            <div class="zone-sub text-mono"><%= z.zoneId %></div>
            <div class="zone-meta">
              <span class="badge-soft"><%= (z.devices || []).length %> устройств</span>
            </div>
          </button>
        <% }) %>
      </div>
    </div>
  </aside>

  <aside class="dashboard-sheet" id="devicesSheet" aria-hidden="true">
    <div class="dashboard-sheet__head">
      <div style="min-width:0;">
        <h2 class="h6 mb-0" id="devicesTitle">Устройства</h2>
        <div class="text-muted small text-mono" id="devicesSub"></div>
      </div>
      <div class="d-flex gap-2 flex-wrap align-items-center page-actions" style="margin-top:0!important;">
        <button class="btn btn-ghost btn-sm" type="button" id="devicesClose">Скрыть</button>
      </div>
    </div>
    <div class="dashboard-sheet__body">
      <div class="device-grid" id="devicesGrid"></div>
      <div class="muted" id="devicesHint" style="margin-top:8px;">Сначала выберите зону в шторке «Зоны».</div>
    </div>
  </aside><% } %>
<style>
  .dashboard-action-card{ cursor:pointer; }
  .dashboard-action-card:focus-visible{ outline:2px solid rgba(255,255,255,.28); outline-offset:2px; }
  .sheet-backdrop{ position:fixed; inset:0; background:rgba(4,8,20,.55); backdrop-filter:blur(2px); z-index:90; opacity:0; transition:opacity .2s ease; }
  .sheet-backdrop.show{ opacity:1; }
  .dashboard-sheet{
    position:fixed; top:16px; right:16px; bottom:16px; width:min(720px, calc(100vw - 24px));
    background:linear-gradient(180deg, rgba(20,25,40,.98), rgba(8,12,26,.98));
    border:1px solid rgba(255,255,255,.12); border-radius:16px; box-shadow:0 20px 50px rgba(0,0,0,.45);
    z-index:95; display:flex; flex-direction:column; transform:translateX(calc(100% + 24px)); opacity:0;
    transition:transform .24s ease, opacity .24s ease; pointer-events:none;
  }
  .dashboard-sheet.open{ transform:translateX(0); opacity:1; pointer-events:auto; }
  .dashboard-sheet__head{ display:flex; align-items:flex-start; justify-content:space-between; gap:8px; padding:14px 14px 10px; border-bottom:1px solid rgba(255,255,255,.08); }
  .dashboard-sheet__body{ padding:12px 14px 14px; overflow:auto; }
  body.sheet-open{ overflow:hidden; }
  .dashboard-sheet .zone-grid{ margin-top:4px; }
  .dashboard-sheet .device-btn{ justify-content:flex-start; text-align:left; width:100%; color:#eaf2ff !important;   background:linear-gradient(180deg, rgba(80,128,255,.20), rgba(80,128,255,.12)) !important;   border-color:rgba(110,160,255,.34) !important; }
  .dashboard-sheet .device-btn:hover{ border-color:rgba(156,201,255,.36) !important; transform:translateY(-1px); }
  .dashboard-sheet .device-btn:active{ transform:translateY(0); }
  .dashboard-sheet .device-btn .muted{ color:rgba(234,242,255,.72) !important; }
  html[data-theme="light"] .sheet-backdrop{ background:rgba(15,23,42,.12); backdrop-filter:blur(2px); }
  html[data-theme="light"] .dashboard-sheet{
    background:linear-gradient(180deg, rgba(255,255,255,.985), rgba(246,250,255,.985));
    border-color:rgba(15,23,42,.10);
    box-shadow:0 20px 48px rgba(15,23,42,.18);
  }
  html[data-theme="light"] .dashboard-sheet__head{ border-bottom-color:rgba(15,23,42,.08); }
  html[data-theme="light"] .dashboard-sheet .device-btn{ color:rgba(17,24,39,.92) !important; background:rgba(255,255,255,.95) !important; border-color:rgba(32,82,255,.16) !important; box-shadow:0 8px 22px rgba(15,23,42,.08); }
  html[data-theme="light"] .dashboard-sheet .device-btn .muted{ color:rgba(71,85,105,.9) !important; }
  @media (max-width: 700px){
    .dashboard-sheet{ top:auto; left:8px; right:8px; bottom:8px; width:auto; max-height:85vh; transform:translateY(calc(100% + 16px)); }
    .dashboard-sheet.open{ transform:translateY(0); }
  }
</style>

<script>
  const BY_ZONE = <%- JSON.stringify(_byZone) %>;

  async function openDevice(id, btn){
    const oldHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span style="display:flex; width:100%; justify-content:center;">Открываю…</span>';
    try{
      const r = await fetch('/api/open/' + encodeURIComponent(id), { method:'POST' });
      const j = await r.json().catch(()=>({}));
      if(!r.ok || !j.ok) throw new Error(j.error || 'Ошибка');
      btn.innerHTML = '<span style="display:flex; width:100%; justify-content:center;">Открыто ✓</span>';
      setTimeout(()=>{ btn.innerHTML = oldHtml; }, 900);
    }catch(e){
      alert(e.message || 'Ошибка');
      btn.innerHTML = oldHtml;
    }finally{
      btn.disabled = false;
    }
  }

  (function(){
    const zoneGrid = document.getElementById('zoneGrid');
    if (!zoneGrid) return;

    const grid = document.getElementById('devicesGrid');
    const title = document.getElementById('devicesTitle');
    const sub = document.getElementById('devicesSub');
    const hint = document.getElementById('devicesHint');
    const zonesSheet = document.getElementById('zonesSheet');
    const devicesSheet = document.getElementById('devicesSheet');
    const backdrop = document.getElementById('dashboardSheetBackdrop');
    const selectedZoneLabel = document.getElementById('selectedZoneLabel');
    const devicesCountLabel = document.getElementById('devicesCountLabel');

    function clearActive(){
      zoneGrid.querySelectorAll('.zone-tile').forEach(b=>b.classList.remove('active'));
    }

    function syncBackdrop(){
      const anyOpen = (zonesSheet && zonesSheet.classList.contains('open')) || (devicesSheet && devicesSheet.classList.contains('open'));
      if (backdrop){
        backdrop.hidden = !anyOpen;
        backdrop.classList.toggle('show', anyOpen);
      }
      document.body.classList.toggle('sheet-open', anyOpen);
    }

    function openSheet(name){
      if (name === 'zones' && zonesSheet) zonesSheet.classList.add('open');
      if (name === 'devices' && devicesSheet) devicesSheet.classList.add('open');
      if (name === 'zones' && devicesSheet) devicesSheet.classList.remove('open');
      if (name === 'devices' && zonesSheet) zonesSheet.classList.remove('open');
      syncBackdrop();
    }

    function closeSheets(){
      if (zonesSheet) zonesSheet.classList.remove('open');
      if (devicesSheet) devicesSheet.classList.remove('open');
      syncBackdrop();
    }

    function renderDevices(zoneIdx){
      const z = BY_ZONE[zoneIdx];
      if (!z) return;

      clearActive();
      const activeBtn = zoneGrid.querySelector('[data-zone-index="' + zoneIdx + '"]');
      if (activeBtn) activeBtn.classList.add('active');

      if (hint) hint.style.display = 'none';

      if (title) title.textContent = z.zoneName || 'Устройства';
      if (sub) sub.textContent = z.zoneId || '';
      if (selectedZoneLabel) selectedZoneLabel.textContent = z.zoneName || 'Зона выбрана';
      if (devicesCountLabel) devicesCountLabel.textContent = `${(z.devices || []).length} устройств`;

      if (!grid) return;
      grid.innerHTML = '';

      (z.devices || []).forEach(d => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-primary device-btn';
        btn.type = 'button';
        btn.dataset.deviceId = d.id;
        btn.innerHTML = `
          <span style="display:flex; align-items:center; justify-content:space-between; gap:10px; width:100%;">
            <span style="text-align:left; min-width:0;">
              <div style="font-weight:800; line-height:1.2;">${escapeHtml(d.name || '')}</div>
              <div class="muted" style="font-size:12px; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(d.id || '')}</div>
            </span>
            <span style="opacity:.75; font-size:18px;">›</span>
          </span>
        `;
        grid.appendChild(btn);
      });

      openSheet('devices');
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#39;');
    }

    function bindOpen(el, target){
      if (!el) return;
      el.addEventListener('click', (e) => {
        if (e.target.closest && e.target.closest('button') && e.target !== el) return;
        openSheet(target);
      });
      el.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openSheet(target); }
      });
    }

    bindOpen(document.getElementById('openZonesSheetCard'), 'zones');
    bindOpen(document.getElementById('openDevicesSheetCard'), 'devices');
    document.getElementById('openZonesSheetBtn')?.addEventListener('click', (e)=>{ e.stopPropagation(); openSheet('zones'); });
    document.getElementById('openDevicesSheetBtn')?.addEventListener('click', (e)=>{ e.stopPropagation(); openSheet('devices'); });
    document.querySelectorAll('[data-close-sheet]').forEach(b=>b.addEventListener('click', closeSheets));
    if (backdrop) backdrop.addEventListener('click', closeSheets);
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeSheets(); });

    zoneGrid.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-zone-index]');
      if (!btn) return;
      renderDevices(btn.getAttribute('data-zone-index'));
    });

    if (grid){
      grid.addEventListener('click', (e) => {
        const btn = e.target.closest('[data-device-id]');
        if (!btn) return;
        openDevice(btn.dataset.deviceId, btn);
      });
    }

    const close = document.getElementById('devicesClose');
    if (close){
      close.addEventListener('click', () => {
        if (hint) hint.style.display = '';
        clearActive();
        if (grid) grid.innerHTML = '';
        if (title) title.textContent = 'Устройства';
        if (sub) sub.textContent = '';
        if (selectedZoneLabel) selectedZoneLabel.textContent = 'Зона не выбрана';
        if (devicesCountLabel) devicesCountLabel.textContent = 'Сначала выберите зону';
        closeSheets();
      });
    }
  })();
</script>

<%- include('partials/footer') %>
