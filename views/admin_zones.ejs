<%- include('partials/header', { title, bodyClass, user, path: '/admin/zones' }) %>

<div class="mb-3">
  <div class="d-flex flex-wrap gap-2 align-items-start justify-content-between">
    <h1 class="h4 mb-0">Зоны</h1>
    <div class="d-flex flex-wrap gap-2 align-items-center page-actions">
      <a class="btn btn-soft" href="/admin/users">Пользователи</a>
      <a class="btn btn-soft" href="/admin/devices">Устройства</a>
      <a class="btn btn-soft" href="/admin/audit">Аудит</a>
    </div>
  </div>
  <div class="text-muted small">Список зон доступа</div>
</div>

<div class="card card-glass p-3 p-md-4 mb-4">
  <h2 class="h6 mb-3">Добавить / обновить зону</h2>
  <form method="post" action="/admin/zones/create" class="row g-2">
    <div class="col-12 col-md-4">
      <input class="form-control" name="id" placeholder="ID (можно пусто)" />
    </div>
    <div class="col-12 col-md-6">
      <input class="form-control" name="name" placeholder="Название" required />
    </div>
    <div class="col-12 col-md-2 d-grid">
      <button class="btn btn-primary" type="submit">Сохранить</button>
    </div>
  </form>
</div>

<div class="card card-glass p-0 overflow-hidden">
  <div class="table-responsive">
    <table class="table table-dark table-hover align-middle mb-0">
      <thead>
        <tr>
          <th>ID</th>
          <th>Название</th>
          <th>Устройства</th>
          <th class="text-end">Действия</th>
        </tr>
      </thead>
      <tbody>
      <% zones.forEach(z => { %>
        <tr>
          <td class="text-nowrap"><code><%= z.id %></code></td>
          <td><%= z.name %></td>
          <% const ds = (devicesByZone && devicesByZone[z.id]) ? devicesByZone[z.id] : []; %>
          <td>
            <% if (ds.length) { %>
              <div class="chips">
                <% ds.slice(0,8).forEach(d => { %>
                  <span class="chip"><%= d.name || d.id %></span>
                <% }) %>
                <% if (ds.length > 8) { %><span class="chip">+<%= ds.length - 8 %></span><% } %>
              </div>
            <% } else { %>
              <span class="text-muted">—</span>
            <% } %>
          </td>
          <td class="text-end">
            <form method="post" action="/admin/zones/<%= z.id %>/delete" onsubmit="return confirm('Удалить зону?');" style="display:inline">
              <button class="btn btn-danger btn-sm" type="submit">Удалить</button>
            </form>
          </td>
        </tr>
      <% }) %>
      </tbody>
    </table>
  </div>
</div>

<%- include('partials/footer') %>
