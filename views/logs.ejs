<% const pageTitle = (typeof title !== "undefined" && title) ? title : "Журнал транзита"; %>
<%- include('partials/header', { title: pageTitle, bodyClass, user, path: '/logs' }) %>

<%
  // Локальные подписи для журнала (выводим по-русски, но фильтруем по исходным значениям)
  const EVENT_LABELS = {
    open: 'Открытие',
    close: 'Закрытие',
    unlock: 'Открытие',
    lock: 'Закрытие',
    error: 'Ошибка',
  };
  const eventLabel = (ev) => {
    const k = String(ev || '').trim();
    return EVENT_LABELS[k] || k;
  };

  // Фолбэк: форматируем время в МСК (если сервер не прислал готовую строку)
  const formatTs = (v) => {
    if (!v) return '';
    const d = (v instanceof Date) ? v : new Date(v);
    if (Number.isNaN(d.getTime())) return String(v);
    try {
      return new Intl.DateTimeFormat('ru-RU', {
        timeZone: 'Europe/Moscow',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hourCycle: 'h23',
      }).format(d).replace(',', '');
    } catch (e) {
      return String(v);
    }
  };
%>
<div class="d-flex flex-wrap gap-2 align-items-center justify-content-between mb-3">
  <div>
    <h1 class="h4 mb-0">Журнал транзита</h1>
    <div class="text-muted small">Последние 500 событий</div>
  </div>
  <div class="d-flex flex-wrap gap-2 logs-top-actions">
    <a class="btn btn-soft" href="/">На главную</a>
    <a class="btn btn-soft" href="<%= exportUrlBase || '/logs.csv' %>">CSV</a>
  </div>
</div>

<div class="card card-glass p-3 mb-3">
  <form class="row gy-2 gx-2 align-items-end" method="get" action="/logs">
    <div class="col-6 col-md-3">
      <label class="form-label">Точка</label>
      <select class="form-select" name="point">
        <option value="">Все</option>
        <% ((options && options.points) ? options.points : []).forEach(p => { %>
          <option value="<%= p %>" <%= (filters && filters.point === p) ? 'selected' : '' %>><%= p %></option>
        <% }) %>
      </select>
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">Событие</label>
      <select class="form-select" name="event">
        <option value="">Все</option>
        <% ((options && options.events) ? options.events : []).forEach(ev => { %>
          <option value="<%= ev %>" <%= (filters && filters.event === ev) ? 'selected' : '' %>><%= eventLabel(ev) %></option>
        <% }) %>
      </select>
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">С</label>
      <input class="form-control" type="date" name="date_from" value="<%= (filters && filters.date_from) ? filters.date_from : '' %>">
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">По</label>
      <input class="form-control" type="date" name="date_to" value="<%= (filters && filters.date_to) ? filters.date_to : '' %>">
    </div>
    <div class="col-12 col-md-2">
      <button class="btn btn-primary w-100" type="submit">Фильтр</button>
    </div>
  </form>
</div>

<div class="card card-glass p-0 overflow-hidden">
  <div class="table-responsive">
    <table class="table table-dark table-hover align-middle m-0">
      <thead>
        <tr>
          <th>Дата/время</th>
          <th>Точка</th>
          <th>Событие</th>
          <th>Кто</th>
          <th class="d-none d-lg-table-cell">Орг/должность</th>
          <th class="d-none d-xl-table-cell">Телефон</th>
          <th class="d-none d-xl-table-cell">Источник</th>
          <th class="d-none d-md-table-cell">Результат</th>
          <th class="d-none d-md-table-cell">Сессия</th>
        </tr>
      </thead>
      <tbody>
        <% (logs || []).forEach(e => { %>
          <tr>
            <td class="text-nowrap"><%= e.datetime_msk || formatTs(e.datetime || e.ts || e.time) %></td>
            <td><span class="badge badge-soft"><%= e.point || '' %></span></td>
            <td><%= eventLabel(e.event || '') %></td>
            <td><%= (e.actor_fio || '').trim() || (e.source || '') %></td>
            <td class="d-none d-lg-table-cell"><%= [e.actor_organization, e.actor_position].filter(Boolean).join(' / ') %></td>
            <td class="d-none d-xl-table-cell"><%= e.actor_phone || '' %></td>
            <td class="d-none d-xl-table-cell"><%= e.source || '' %></td>
            <td class="d-none d-md-table-cell"><%= e.result || '' %></td>
            <td class="d-none d-md-table-cell"><%= e.session || '' %></td>
          </tr>
        <% }) %>
        <% if (!logs || !logs.length) { %>
          <tr><td colspan="9" class="text-muted p-4">Пока пусто</td></tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>


<%- include('partials/footer') %>
