<%- include('partials/header', { title, user, bodyClass }) %>

<div class="d-flex align-items-center justify-content-between mb-3">
  <h1 class="h5 m-0"><%= title %></h1>
  <div class="text-muted small">показано: <%= logs.length %></div>
</div>


<script>
  function qs(obj){
    const p = new URLSearchParams();
    Object.entries(obj).forEach(([k,v])=>{ if(v) p.set(k,v); });
    const s = p.toString();
    return s ? ('?' + s) : '';
  }
</script>

<div class="card glass mb-3">
  <div class="card-body">
    <form class="row g-2 align-items-end" method="GET" action="">
      <div class="col-12 col-md-3">
        <label class="form-label small text-muted">Точка</label>
        <select class="form-select" name="point">
          <option value="">Все</option>
          <% (options?.points || []).forEach(p => { %>
            <option value="<%= p %>" <%= (filters?.point === p ? 'selected' : '') %>><%= p %></option>
          <% }) %>
        </select>
      </div>

      <div class="col-12 col-md-3">
        <label class="form-label small text-muted">Событие</label>
        <select class="form-select" name="event">
          <option value="">Все</option>
          <% (options?.events || []).forEach(ev => { %>
            <option value="<%= ev %>" <%= (filters?.event === ev ? 'selected' : '') %>><%= ev %></option>
          <% }) %>
        </select>
      </div>

      <div class="col-6 col-md-2">
        <label class="form-label small text-muted">Дата с</label>
        <input class="form-control" type="date" name="date_from" value="<%= (filters?.date_from || '') %>">
      </div>

      <div class="col-6 col-md-2">
        <label class="form-label small text-muted">Дата по</label>
        <input class="form-control" type="date" name="date_to" value="<%= (filters?.date_to || '') %>">
      </div>

      <div class="col-12 col-md-2 d-flex gap-2">
        <button class="btn btn-primary w-100" type="submit">Фильтр</button>
        <a class="btn btn-outline-secondary w-100" href="<%= (exportUrlBase || '/logs.csv') + qs(filters || {}) %>">CSV</a>
      </div>

      <div class="col-12">
        <a class="small text-muted" href="<%= (typeof window === 'undefined' ? '' : '') %>"> </a>
        <a class="small link-light" href="?">Сбросить фильтры</a>
      </div>
    </form>
  </div>
</div>

<div class="log-mobile-list d-block d-md-none">
  <% logs.forEach(l => { %>
    <div class="lux-card mb-2">
      <div class="lux-card-head">
        <div class="lux-badge"><%= l.event || '-' %></div>
        <div class="lux-muted"><%= (l.datetime ? new Date(l.datetime).toLocaleString('ru-RU') : '-') %></div>
      </div>
      <div class="lux-card-body">
        <div class="lux-row"><span class="lux-label">Точка</span><span class="lux-value"><%= l.point || '-' %></span></div>
        <div class="lux-row"><span class="lux-label">Источник</span><span class="lux-value lux-muted"><%= l.source || '-' %></span></div>
        <div class="lux-row"><span class="lux-label">Результат</span><span class="lux-value"><%= l.result || '—' %></span></div>
        <% if (l.session) { %>
          <div class="lux-row"><span class="lux-label">Сессия</span><span class="lux-value"><code class="mono"><%= l.session %></code></span></div>
        <% } %>
      </div>
    </div>
  <% }) %>
  <% if (!logs.length) { %>
    <div class="lux-card"><div class="lux-card-body lux-muted">Пока пусто.</div></div>
  <% } %>
</div>

<div class="card shadow-sm d-none d-md-block">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0 table-lux">
        <thead>
          <tr>
            <th style="white-space:nowrap">Дата/время</th>
            <th>Точка</th>
            <th>Событие</th>
            <th>Пользователь/источник</th>
            <th>Результат</th>
            <th style="white-space:nowrap">Номер сессии</th>
          </tr>
        </thead>
        <tbody>
          <% logs.forEach(l => { %>
            <tr>
              <td style="white-space:nowrap"><%= (l.datetime ? new Date(l.datetime).toLocaleString('ru-RU') : '-') %></td>
              <td><%= l.point || '-' %></td>
              <td><span class="badge rounded-pill badge-lux"><%= l.event || '-' %></span></td>
              <td class="lux-muted"><%= l.source || '-' %></td>
              <td><%= l.result || '—' %></td>
              <td class="lux-muted mono"><%= l.session || '-' %></td>
            </tr>
          <% }) %>
          <% if (!logs.length) { %>
            <tr><td colspan="6" class="lux-muted p-4">Пока пусто.</td></tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>
</div>
<%- include('partials/footer') %>
