<% const pageTitle = (typeof title !== "undefined" && title) ? title : "Журнал транзита"; %>
<%- include('partials/header', { title: pageTitle, bodyClass, user }) %>

<%
  // EJS helpers must be defined server-side (a <script> tag runs in the browser and can't be used in <%= %>).
  const formatTs = (v) => {
    if (!v) return '';
    const d = (v instanceof Date) ? v : new Date(v);
    if (Number.isNaN(d.getTime())) return String(v);
    const pad = (n) => String(n).padStart(2, '0');
    return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  };
%>
<div class="d-flex flex-wrap gap-2 align-items-center justify-content-between mb-3">
  <div>
    <h1 class="h4 mb-0">Журнал транзита</h1>
    <div class="text-muted small">Последние 500 событий</div>
  </div>
  <div class="d-flex flex-wrap gap-2">
    <a class="btn btn-soft" href="/">На главную</a>
    <a class="btn btn-soft" href="<%= exportUrlBase || '/logs.csv' %>">CSV</a>
  </div>
</div>

<div class="card card-glass p-3 mb-3">
  <form class="row gy-2 gx-2 align-items-end" method="get" action="/logs">
    <div class="col-6 col-md-3">
      <label class="form-label">Точка</label>
      <select class="form-select" name="point">
        <option value="">Все</option>
        <% (options?.points || []).forEach(p => { %>
          <option value="<%= p %>" <%= filters?.point===p ? 'selected' : '' %>><%= p %></option>
        <% }) %>
      </select>
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">Событие</label>
      <select class="form-select" name="event">
        <option value="">Все</option>
        <% (options?.events || []).forEach(ev => { %>
          <option value="<%= ev %>" <%= filters?.event===ev ? 'selected' : '' %>><%= ev %></option>
        <% }) %>
      </select>
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">С</label>
      <input class="form-control" type="date" name="date_from" value="<%= filters?.date_from || '' %>">
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">По</label>
      <input class="form-control" type="date" name="date_to" value="<%= filters?.date_to || '' %>">
    </div>
    <div class="col-12 col-md-2">
      <button class="btn btn-primary w-100" type="submit">Фильтр</button>
    </div>
  </form>
</div>

<div class="card card-glass p-0 overflow-hidden">
  <div class="table-responsive">
    <table class="table table-dark table-hover align-middle m-0">
      <thead>
        <tr>
          <th>Дата/время</th>
          <th>Точка</th>
          <th>Событие</th>
          <th class="d-none d-md-table-cell">Источник</th>
          <th class="d-none d-md-table-cell">Результат</th>
          <th class="d-none d-md-table-cell">Сессия</th>
        </tr>
      </thead>
      <tbody>
        <% (logs || []).forEach(e => { %>
          <tr>
            <td class="text-nowrap"><%= formatTs(e.datetime || e.ts || e.time) %></td>
            <td><span class="badge badge-soft"><%= e.point || '' %></span></td>
            <td><%= e.event || '' %></td>
            <td class="d-none d-md-table-cell"><%= e.source || '' %></td>
            <td class="d-none d-md-table-cell"><%= e.result || '' %></td>
            <td class="d-none d-md-table-cell"><%= e.session || '' %></td>
          </tr>
        <% }) %>
        <% if (!logs || !logs.length) { %>
          <tr><td colspan="6" class="text-muted p-4">Пока пусто</td></tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<script>
  function formatTs(v){
    if(!v) return '';
    try{
      const d = new Date(v);
      if(String(d) === 'Invalid Date') return String(v);
      return d.toISOString().replace('T',' ').replace('Z','');
    }catch(e){
      return String(v);
    }
  }
</script>

<%- include('partials/footer') %>
