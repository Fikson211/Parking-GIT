<%- include('partials/header', { title, bodyClass, user, path: '/admin/users' }) %>

<% const _allZones = Array.isArray(allZones) ? allZones : (Array.isArray(zones) ? zones : []); %>
<% const _isISAdmin = !!(user && user.is_is_admin); %>

<div class="mb-3">
  <div class="d-flex flex-wrap gap-2 align-items-start justify-content-between">
    <div style="min-width:240px;">
      <h1 class="h4 mb-0">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h1>
      <div class="text-muted small">–ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π —Å–ø–∏—Å–æ–∫ + –∫–∞—Ä—Ç–æ—á–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. PIN –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏ –ø–æ–º–µ–Ω—è—Ç—å.</div>
    </div>
    <div class="d-flex flex-wrap gap-2 align-items-center page-actions">
      <% if (user && user.is_is_admin) { %>
        <a class="btn btn-soft" href="/admin/devices">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</a>
        <a class="btn btn-soft" href="/admin/zones">–ó–æ–Ω—ã</a>
      <% } %>
      <a class="btn btn-soft" href="/admin/audit">–ê—É–¥–∏—Ç</a>
    </div>
  </div>
</div>

<div class="card card-glass p-3 mb-3">
  <h2 class="h6 mb-2">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
  <form method="post" action="/admin/users/create" class="row g-2">
    <div class="col-12 col-md-3">
      <input name="fio" class="form-control" placeholder="–§–ò–û" required />
    </div>
    <div class="col-12 col-md-3">
      <input name="organization" class="form-control" placeholder="–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è (–æ–ø—Ü.)" />
    </div>
    <div class="col-12 col-md-2">
      <input name="position" class="form-control" placeholder="–î–æ–ª–∂–Ω–æ—Å—Ç—å (–æ–ø—Ü.)" />
    </div>
    <div class="col-12 col-md-2">
      <input name="phone" class="form-control" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (—Ü–∏—Ñ—Ä—ã)" required />
    </div>
    <div class="col-12 col-md-1">
      <input name="pin" class="form-control" placeholder="PIN" />
    </div>
    <div class="col-12 col-md-1">
      <select name="role" class="form-select">
        <option value="user">user</option>
        <option value="admin">admin</option>
      </select>
    </div>
    <% if (user && user.is_is_admin) { %>
    <div class="col-12 col-md-2 d-flex align-items-center">
      <label class="form-check mb-0">
        <input class="form-check-input me-1" type="checkbox" name="is_is_admin" value="true">
        <span class="form-check-label">–ò–° –∞–¥–º–∏–Ω</span>
      </label>
    </div>
    <% } %>
    <% if (_isISAdmin) { %>
    <div class="col-12">
      <label class="form-label">–ó–æ–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –Ω–∞–∑–Ω–∞—á–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º (–¥–ª—è —Ä–æ–ª–∏ admin)</label>
      <div class="d-flex flex-wrap gap-2">
        <% _allZones.forEach(z => { %>
          <label class="form-check form-check-inline badge-soft px-2 py-1">
            <input class="form-check-input me-1" type="checkbox" name="assignable_zones" value="<%= z.id %>">
            <span class="form-check-label"><%= z.name %></span>
          </label>
        <% }) %>
      </div>
      <div class="small text-muted">–†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –∞–¥–º–∏–Ω–æ–≤. –î–ª—è –ò–°-–∞–¥–º–∏–Ω–∞ –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è.</div>
    </div>
    <% } %>

    <div class="col-12">
      <button class="btn btn-gold w-100" type="submit">–°–æ–∑–¥–∞—Ç—å</button>
    </div>
    <div class="col-12">
      <div class="small text-muted text-wrap">–ó–æ–Ω—ã –Ω–∞–∑–Ω–∞—á–∞—é—Ç—Å—è –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è ‚Äî –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.</div>
    </div>
  </form>
</div>

<div class="d-flex flex-wrap gap-2 align-items-center justify-content-between mb-2">
  <div class="text-muted small">–í—Å–µ–≥–æ: <%= (users || []).length %></div>
  <div style="flex: 1 1 280px; max-width: 380px;">
    <input id="userSearch" class="form-control" placeholder="–ü–æ–∏—Å–∫: –§–ò–û / –¥–æ–ª–∂–Ω–æ—Å—Ç—å / –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è / —Ç–µ–ª–µ—Ñ–æ–Ω" />
  </div>
</div>

<div class="users-grid" id="usersGrid">
  <% (users || []).forEach(u => { %>
    <div class="user-card" data-user-id="<%= u.id %>">
      <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
        <div style="min-width:220px; flex:1 1 220px;">
          <div class="user-name"><%= u.fio || '‚Äî' %></div>
          <div class="user-sub text-mono"><%= (u.phone || '').replace(/\D/g,'') %></div>
          <div class="text-muted small" style="line-height:1.2;">
            <%= [u.organization, u.position].filter(Boolean).join(' ‚Ä¢ ') || '' %>
          </div>
        </div>
        <div class="d-flex gap-1 flex-wrap align-items-center" style="justify-content:flex-end;">
          <span class="badge-soft"><%= (u.role === 'admin') ? 'admin' : 'user' %></span>
          <span class="badge-soft"><%= (u.is_active !== false) ? 'active' : 'off' %></span>
          <span class="badge-soft"><%= Array.isArray(u.zones) ? u.zones.length : 0 %> –∑–æ–Ω</span>
        </div>
      </div>
      <div class="user-actions">
        <button class="btn btn-soft btn-sm" type="button" data-edit-user="<%= u.id %>">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å</button>
        <span class="muted small">id: <span class="text-mono"><%= u.id %></span></span>
      </div>
    </div>
  <% }) %>

  <% if (!users || !users.length) { %>
    <div class="card">
      <div class="muted">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç</div>
    </div>
  <% } %>
</div>

<!-- Modal: compact user editor -->
<div class="modal-backdrop" id="userModal" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
    <div class="modal-header">
      <div style="min-width:0;">
        <div class="modal-title" id="mTitle">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
        <div class="text-muted small text-mono" id="mSub"></div>
      </div>
      <button type="button" class="btn btn-ghost btn-sm" id="mClose">‚úï</button>
    </div>

    <div class="modal-body">
      <form id="userUpdateForm" method="post" action="">
        <div class="modal-grid">
          <div>
            <label class="form-label">–§–ò–û</label>
            <input name="fio" class="form-control" id="mFio" required />
          </div>

          <div>
            <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <input name="phone" class="form-control" id="mPhone" required />
          </div>

          <div>
            <label class="form-label">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</label>
            <input name="organization" class="form-control" id="mOrg" placeholder="(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" />
          </div>

          <div>
            <label class="form-label">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
            <input name="position" class="form-control" id="mPos" placeholder="(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" />
          </div>

          <div>
            <label class="form-label">–†–æ–ª—å</label>
            <select name="role" class="form-select" id="mRole">
              <option value="user">user</option>
              <option value="admin">admin</option>
            </select>
          </div>

          <div>
            <label class="form-label">–ê–∫—Ç–∏–≤–µ–Ω</label>
            <div class="form-check form-switch" style="align-items:center;">
              <input class="form-check-input" type="checkbox" id="mActive" name="is_active">
              <span class="text-muted small">–≤–∫–ª/–≤—ã–∫–ª</span>
            </div>
          </div>

          <div style="grid-column: 1 / -1;">
            <label class="form-label">PIN (–ø–∞—Ä–æ–ª—å)</label>
            <div class="d-flex flex-wrap gap-2 align-items-center">
              <span class="badge-soft text-mono" id="mCurPin" data-pin="">PIN: ‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
              <button type="button" class="btn btn-soft btn-sm" id="mCurPinToggle" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å">üëÅ</button>
              <div style="flex: 1 1 260px; min-width: 220px;">
                <input name="pin" class="form-control" id="mNewPin" type="password" inputmode="numeric" placeholder="–ù–æ–≤—ã–π PIN (4 —Ü–∏—Ñ—Ä—ã)" />
                <div class="text-muted small">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º ‚Äî PIN –Ω–µ –∏–∑–º–µ–Ω–∏—Ç—Å—è.</div>
              </div>
            </div>
          </div>

          <div style="grid-column: 1 / -1;">
            <label class="form-label">–ó–æ–Ω—ã –¥–æ—Å—Ç—É–ø–∞</label>
            <div class="d-flex flex-wrap gap-1" id="mZones">
              <% (zones || []).forEach(z => { %>
                <label class="zone-chip">
                  <input class="form-check-input me-1" type="checkbox" name="zones" value="<%= z.id %>" data-zone-id="<%= z.id %>">
                  <span><%= z.name %></span>
                </label>
              <% }) %>
            </div>
          </div>

          <% if (_isISAdmin) { %>
          <div style="grid-column: 1 / -1;">
            <label class="form-label">–ó–æ–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –Ω–∞–∑–Ω–∞—á–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º (–¥–ª—è —Ä–æ–ª–∏ admin)</label>
            <div class="d-flex flex-wrap gap-1" id="mAssignableZones">
              <% _allZones.forEach(z => { %>
                <label class="zone-chip">
                  <input class="form-check-input me-1" type="checkbox" name="assignable_zones" value="<%= z.id %>" data-assignable-zone-id="<%= z.id %>">
                  <span><%= z.name %></span>
                </label>
              <% }) %>
            </div>
            <div class="small text-muted">–î–ª—è –ò–°-–∞–¥–º–∏–Ω–∞ –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è.</div>
          </div>
          <% } %>
        </div>
      </form>

      <form id="userResetForm" method="post" action=""></form>
      <form id="userDeleteForm" method="post" action=""></form>
    </div>

    <div class="modal-footer">
      <button class="btn btn-soft" type="button" id="mCancel">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-gold" type="submit" form="userResetForm">–°–±—Ä–æ—Å PIN</button>
      <button class="btn btn-danger" type="submit" form="userDeleteForm" id="mDelete">–£–¥–∞–ª–∏—Ç—å</button>
      <button class="btn btn-primary" type="submit" form="userUpdateForm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<script>
  const USERS = <%- JSON.stringify(users || []) %>;

  const modal = document.getElementById('userModal');
  const closeBtn = document.getElementById('mClose');
  const cancelBtn = document.getElementById('mCancel');

  const t = document.getElementById('mTitle');
  const s = document.getElementById('mSub');

  const fio = document.getElementById('mFio');
  const phone = document.getElementById('mPhone');
  const org = document.getElementById('mOrg');
  const pos = document.getElementById('mPos');
  const role = document.getElementById('mRole');
  const active = document.getElementById('mActive');

  const curPin = document.getElementById('mCurPin');
  const curPinToggle = document.getElementById('mCurPinToggle');
  const newPin = document.getElementById('mNewPin');

  const updateForm = document.getElementById('userUpdateForm');
  const resetForm = document.getElementById('userResetForm');
  const deleteForm = document.getElementById('userDeleteForm');

  function digitsOnly(v){
    return String(v || '').replace(/\D/g, '');
  }

  function openModal(userId){
    const u = USERS.find(x => String(x.id) === String(userId));
    if (!u) return;

    // header
    t.textContent = u.fio || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    s.textContent = digitsOnly(u.phone) ? digitsOnly(u.phone) : String(u.id);

    // forms actions
    updateForm.action = '/admin/users/' + encodeURIComponent(u.id) + '/update';
    resetForm.action = '/admin/users/' + encodeURIComponent(u.id) + '/reset_pin';
    deleteForm.action = '/admin/users/' + encodeURIComponent(u.id) + '/delete';

    // fields
    fio.value = u.fio || '';
    phone.value = digitsOnly(u.phone || '');
    org.value = u.organization || '';
    pos.value = u.position || '';
    role.value = (u.role === 'admin') ? 'admin' : 'user';
    active.checked = (u.is_active !== false);

    // PIN
    const p = digitsOnly(u.pin || '');
    curPin.dataset.pin = p;
    curPin.dataset.shown = '0';
    curPin.textContent = 'PIN: ' + (p ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '‚Äî');
    newPin.value = '';

    // zones
    const assigned = Array.isArray(u.zones) ? u.zones.map(String) : [];
    document.querySelectorAll('#mZones [data-zone-id]').forEach(inp => {
      inp.checked = assigned.includes(String(inp.getAttribute('data-zone-id')));
    });

    const assignable = Array.isArray(u.assignable_zones) ? u.assignable_zones.map(String) : [];
    document.querySelectorAll('#mAssignableZones [data-assignable-zone-id]').forEach(inp => {
      inp.checked = assignable.includes(String(inp.getAttribute('data-assignable-zone-id')));
    });

    modal.classList.add('open');
    modal.setAttribute('aria-hidden', 'false');
    document.body.classList.add('modal-open');
  }

  function closeModal(){
    modal.classList.remove('open');
    modal.setAttribute('aria-hidden', 'true');
    document.body.classList.remove('modal-open');
  }

  curPinToggle?.addEventListener('click', () => {
    const p = curPin.dataset.pin || '';
    const shown = curPin.dataset.shown === '1';
    curPin.dataset.shown = shown ? '0' : '1';
    curPin.textContent = 'PIN: ' + (p ? (shown ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : p) : '‚Äî');
  });

  document.getElementById('usersGrid')?.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-edit-user]');
    if (!btn) return;
    openModal(btn.getAttribute('data-edit-user'));
  });

  closeBtn?.addEventListener('click', closeModal);
  cancelBtn?.addEventListener('click', closeModal);

  modal?.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal?.classList.contains('open')) closeModal();
  });

  // Delete confirmation
  deleteForm?.addEventListener('submit', (e) => {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è? –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) e.preventDefault();
  });

  // Search filter
  const search = document.getElementById('userSearch');
  search?.addEventListener('input', () => {
    const q = (search.value || '').trim().toLowerCase();
    document.querySelectorAll('#usersGrid [data-user-id]').forEach(card => {
      const id = card.getAttribute('data-user-id');
      const u = USERS.find(x => String(x.id) === String(id));
      const hay = ((u?.fio || '') + ' ' + (u?.position || '') + ' ' + (u?.organization || '') + ' ' + digitsOnly(u?.phone || '') + ' ' + String(u?.id || '')).toLowerCase();
      card.style.display = (!q || hay.includes(q)) ? '' : 'none';
    });
  });
</script>

<%- include('partials/footer') %>
