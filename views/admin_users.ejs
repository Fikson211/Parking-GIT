<%- include('partials/header', { title: 'Пользователи', user }) %>

<div class="card">
  <div class="topbar">
    <div class="pill">Админ-панель</div>
    <div class="nav">
      <a href="/" class="pill">Дашборд</a>
      <a href="/logs" class="pill">Журнал</a>
      <a href="/admin/users" class="pill" style="background:rgba(255,255,255,.12)">Пользователи</a>
      <a href="/admin/zones" class="pill">Зоны</a>
      <a href="/admin/devices" class="pill">Устройства</a>
      <a href="/admin/audit" class="pill">Аудит</a>
      <a href="/logout" class="pill">Выйти</a>
    </div>
  </div>

  <h2>Пользователи</h2>

  <form method="POST" action="/admin/users" style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr 1fr 180px;gap:10px;align-items:end;">
    <div>
      <label class="muted">ФИО</label>
      <input name="fio" placeholder="Имя" style="width:100%;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:#fff;" required />
    </div>
    <div>
      <label class="muted">Телефон</label>
      <input name="phone" placeholder="79991112233" style="width:100%;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:#fff;" required />
    </div>
    <div>
      <label class="muted">PIN</label>
      <input name="pin" placeholder="(пусто = автоген)" style="width:100%;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:#fff;" />
    </div>
    <div>
      <label class="muted">Роль</label>
      <select name="role" style="width:100%;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(20,20,25,.9);color:#fff;">
        <option value="user">user</option>
        <option value="admin">admin</option>
      </select>
    </div>
    <div>
      <label class="muted">Зоны (через запятую)</label>
      <input name="zones" placeholder="pedestrian,buffer" style="width:100%;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:#fff;" />
    </div>
    <div>
      <button class="btn" type="submit" style="width:100%">Добавить</button>
    </div>
  </form>

  <div style="overflow:auto;margin-top:14px;">
    <table class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>ФИО</th>
          <th>Телефон</th>
          <th>PIN</th>
          <th>Роль</th>
          <th>Активен</th>
          <th>Зоны</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <% users.forEach(u => { %>
          <tr>
            <td><%= u.id %></td>
            <td><%= u.fio %></td>
            <td><%= u.phone %></td>
            <td><%= (u.pin === null ? '' : u.pin) %></td>
            <td><%= u.role %></td>
            <td><%= u.is_active ? 'да' : 'нет' %></td>
            <td><%= Array.isArray(u.zones) ? u.zones.join(', ') : (u.zones || '') %></td>
            <td style="white-space:nowrap;">
              <form method="POST" action="/admin/users/<%= u.id %>/toggle" style="display:inline">
                <button class="pill" type="submit">Вкл/Выкл</button>
              </form>
              <form method="POST" action="/admin/users/<%= u.id %>/reset-pin" style="display:inline">
                <button class="pill" type="submit">Сброс PIN</button>
              </form>
              <form method="POST" action="/admin/users/<%= u.id %>/delete" style="display:inline" onsubmit="return confirm('Удалить пользователя?')">
                <button class="pill" type="submit">Удалить</button>
              </form>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</div>

<%- include('partials/footer') %>
