<%- include('partials/header', { title, bodyClass, user }) %>

<div class="d-flex flex-wrap gap-2 align-items-center justify-content-between mb-3">
  <div>
    <h1 class="h4 mb-0">Пользователи</h1>
    <div class="text-muted small">PIN генерируется автоматически. Можно сбросить.</div>
  </div>
  <div class="d-flex flex-wrap gap-2">
    <a class="btn btn-soft" href="/admin/devices">Устройства</a>
    <a class="btn btn-soft" href="/admin/zones">Зоны</a>
    <a class="btn btn-soft" href="/admin/audit">Аудит</a>
  </div>
</div>

<div class="card card-glass p-3 mb-3">
  <h2 class="h6 mb-2">Добавить пользователя</h2>
  <form method="post" action="/admin/users/create" class="row g-2">
    <div class="col-12 col-md-4">
      <input name="fio" class="form-control" placeholder="ФИО" required />
    </div>
    <div class="col-12 col-md-3">
      <input name="phone" class="form-control" placeholder="Телефон (цифры)" required />
    </div>
    <div class="col-12 col-md-2">
      <select name="role" class="form-select">
        <option value="user">user</option>
        <option value="admin">admin</option>
      </select>
    </div>
    <div class="col-12 col-md-3">
      <button class="btn btn-gold w-100" type="submit">Создать</button>
    </div>
    <div class="col-12">
      <div class="small text-muted text-wrap">Зоны можно назначить после создания (в списке ниже).</div>
    </div>
  </form>
</div>

<div class="card card-glass p-0 overflow-hidden">
  <div class="table-responsive">
    <table class="table table-dark table-hover align-middle m-0">
      <thead>
        <tr>
          <th>ФИО</th>
          <th>Телефон</th>
          <th>Роль</th>
          <th>Зоны</th>
          <th>Активен</th>
          <th class="text-end">Действия</th>
        </tr>
      </thead>
      <tbody>
        <% users.forEach(u => { %>
          <tr>
            <form method="post" action="/admin/users/<%= u.id %>/update">
              <td style="min-width:220px">
                <input name="fio" class="form-control form-control-sm" value="<%= u.fio || '' %>" />
              </td>
              <td style="min-width:170px">
                <input name="phone" class="form-control form-control-sm" value="<%= (u.phone || '').replace(/\D/g,'') %>" />
              </td>
              <td style="min-width:110px">
                <select name="role" class="form-select form-select-sm">
                  <option value="user" <%= (u.role==='user'?'selected':'') %>>user</option>
                  <option value="admin" <%= (u.role==='admin'?'selected':'') %>>admin</option>
                </select>
              </td>
              <td style="min-width:260px">
                <div class="d-flex flex-wrap gap-1">
                  <% zones.forEach(z => { %>
                    <label class="zone-chip">
                      <input class="form-check-input me-1" type="checkbox" name="zones" value="<%= z.id %>" <%= (Array.isArray(u.zones) && u.zones.includes(z.id)) ? 'checked' : '' %> />
                      <span><%= z.name %></span>
                    </label>
                  <% }) %>
                </div>
              </td>
              <td style="min-width:90px">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" name="is_active" <%= u.is_active ? 'checked' : '' %>>
                </div>
              </td>
              <td class="text-end" style="min-width:230px">
                <div class="d-flex gap-2 justify-content-end">
                  <button class="btn btn-soft btn-sm" type="submit">Сохранить</button>
                </form>
                <form method="post" action="/admin/users/<%= u.id %>/reset_pin" class="m-0">
                  <button class="btn btn-gold btn-sm" type="submit">Сброс PIN</button>
                </form>
                </div>
              </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</div>

<%- include('partials/footer') %>
