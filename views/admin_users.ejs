<%- include('partials/header', { title, bodyClass, user, path: '/admin/users' }) %>

<div class="mb-3">
  <div class="d-flex flex-wrap gap-2 align-items-start justify-content-between">
    <h1 class="h4 mb-0">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h1>
    <div class="d-flex flex-wrap gap-2 align-items-center page-actions">
      <a class="btn btn-soft" href="/admin/devices">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</a>
      <a class="btn btn-soft" href="/admin/zones">–ó–æ–Ω—ã</a>
      <a class="btn btn-soft" href="/admin/audit">–ê—É–¥–∏—Ç</a>
    </div>
  </div>
  <div class="text-muted small">PIN (–ø–∞—Ä–æ–ª—å) –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ê–¥–º–∏–Ω –º–æ–∂–µ—Ç –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏ –∏–∑–º–µ–Ω–∏—Ç—å.</div>
</div>

<div class="card card-glass p-3 mb-3">
  <h2 class="h6 mb-2">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
  <form method="post" action="/admin/users/create" class="row g-2">
    <div class="col-12 col-md-4">
      <input name="fio" class="form-control" placeholder="–§–ò–û" required />
    </div>
    <div class="col-12 col-md-3">
      <input name="phone" class="form-control" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (—Ü–∏—Ñ—Ä—ã)" required />
    </div>
    <div class="col-12 col-md-2">
      <input name="pin" class="form-control" placeholder="PIN (4 —Ü–∏—Ñ—Ä—ã, –æ–ø—Ü.)" />
    </div>
    <div class="col-12 col-md-2">
      <select name="role" class="form-select">
        <option value="user">user</option>
        <option value="admin">admin</option>
      </select>
    </div>
    <div class="col-12 col-md-1">
      <button class="btn btn-gold w-100" type="submit">–°–æ–∑–¥–∞—Ç—å</button>
    </div>
    <div class="col-12">
      <div class="small text-muted text-wrap">–ó–æ–Ω—ã –º–æ–∂–Ω–æ –Ω–∞–∑–Ω–∞—á–∏—Ç—å –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è (–≤ —Å–ø–∏—Å–∫–µ –Ω–∏–∂–µ).</div>
    </div>
  </form>
</div>

<div class="card card-glass p-0 overflow-hidden">
  <div class="table-responsive">
    <table class="table table-dark table-hover align-middle m-0">
      <thead>
        <tr>
          <th>–§–ò–û</th>
          <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
          <th>PIN</th>
          <th>–†–æ–ª—å</th>
          <th>–ó–æ–Ω—ã</th>
          <th>–ê–∫—Ç–∏–≤–µ–Ω</th>
          <th class="text-end">–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody>
        <% (users || []).forEach(u => { %>
          <tr>
            <td style="min-width:220px">
              <input form="upd-<%= u.id %>" name="fio" class="form-control form-control-sm" value="<%= u.fio || '' %>" />
            </td>
            <td style="min-width:170px">
              <input form="upd-<%= u.id %>" name="phone" class="form-control form-control-sm" value="<%= (u.phone || '').replace(/\D/g,'') %>" />
            </td>
            <td style="min-width:190px">
              <div class="d-flex gap-1 align-items-center flex-wrap">
                <input
                  id="pin-input-<%= u.id %>"
                  form="upd-<%= u.id %>"
                  name="pin"
                  class="form-control form-control-sm"
                  type="password"
                  value="<%= (u.pin || '').replace(/\D/g,'') %>"
                  placeholder="PIN"
                  style="min-width:120px; flex:1 1 120px"
                />
                <button
                  type="button"
                  class="btn btn-soft btn-sm"
                  data-toggle-pin="pin-input-<%= u.id %>"
                  title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å"
                >üëÅ</button>
              </div>
            </td>
            <td style="min-width:110px">
              <select form="upd-<%= u.id %>" name="role" class="form-select form-select-sm">
                <option value="user" <%= (u.role === 'user') ? 'selected' : '' %>>user</option>
                <option value="admin" <%= (u.role === 'admin') ? 'selected' : '' %>>admin</option>
              </select>
            </td>
            <td style="min-width:260px">
              <div class="d-flex flex-wrap gap-1">
                <% (zones || []).forEach(z => { %>
                  <label class="zone-chip">
                    <input
                      form="upd-<%= u.id %>"
                      class="form-check-input me-1"
                      type="checkbox"
                      name="zones"
                      value="<%= z.id %>"
                      <%= (Array.isArray(u.zones) && u.zones.includes(z.id)) ? 'checked' : '' %>
                    />
                    <span><%= z.name %></span>
                  </label>
                <% }) %>
              </div>
            </td>
            <td style="min-width:90px">
              <div class="form-check form-switch">
                <input
                  form="upd-<%= u.id %>"
                  class="form-check-input"
                  type="checkbox"
                  name="is_active"
                  <%= (u.is_active !== false) ? 'checked' : '' %>
                >
              </div>
            </td>
            <td class="text-end" style="min-width:250px">
              <div class="d-flex gap-2 justify-content-end flex-wrap align-items-center">
                <button class="btn btn-soft btn-sm" type="submit" form="upd-<%= u.id %>">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn btn-gold btn-sm" type="submit" form="pinreset-<%= u.id %>">–°–±—Ä–æ—Å PIN</button>
              </div>

              <!-- Empty forms: inputs/buttons are linked via form="..." attribute -->
              <form id="upd-<%= u.id %>" method="post" action="/admin/users/<%= u.id %>/update"></form>
              <form id="pinreset-<%= u.id %>" method="post" action="/admin/users/<%= u.id %>/reset_pin" class="m-0"></form>
            </td>
          </tr>
        <% }) %>
        <% if (!users || !users.length) { %>
          <tr><td colspan="7" class="text-muted p-3">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç</td></tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<script>
  // Toggle PIN visibility for admin
  document.querySelectorAll('[data-toggle-pin]').forEach((btn) => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-toggle-pin');
      const inp = document.getElementById(id);
      if (!inp) return;
      inp.type = (inp.type === 'password') ? 'text' : 'password';
    });
  });
</script>

<%- include('partials/footer') %>
