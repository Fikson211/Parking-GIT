<%- include('partials/header', { title: 'Админ • Аудит', bodyClass, user, path: '/admin/audit' }) %>

<div class="mb-3">
  <div class="d-flex flex-wrap gap-2 align-items-start justify-content-between">
    <h1 class="h4 mb-0">Аудит</h1>
    <div class="d-flex flex-wrap gap-2 align-items-center page-actions">
      <a class="btn btn-soft" href="/admin/audit.csv">CSV</a>
      <form method="post" action="/admin/audit/clear" onsubmit="return confirm('Очистить журнал аудита?');">
        <button type="submit" class="btn btn-soft">Очистить</button>
      </form>
      <a class="btn btn-soft" href="/admin/users">Пользователи</a>
      <a class="btn btn-soft" href="/">На главную</a>
    </div>
  </div>
  <div class="text-muted small">Последние 500 действий</div>
</div>

<div class="card card-glass p-2 p-md-3">
  <div class="table-responsive">
    <table class="table table-dark table-hover align-middle mb-0">
      <thead>
        <tr>
          <th>Время</th>
          <th>Кто</th>
          <th>Действие</th>
          <th>Цель</th>
          <th class="d-none d-md-table-cell">Детали</th>
        </tr>
      </thead>
      <tbody>
      <% (entries || []).forEach(function(e){ 
          const ts = e.ts ? new Date(e.ts) : null;
          const fmt = ts ? ts.toISOString().replace('T',' ').replace('Z','') : '';
      %>
        <tr>
          <td class="small text-muted"><%= fmt %></td>
          <td>
            <div class="fw-semibold"><%= e.actorFio || '—' %></div>
            <div class="small text-muted"><%= [e.actorOrganization, e.actorPosition].filter(Boolean).join(' • ') %></div>
            <div class="small text-muted"><%= e.actorPhone || '' %></div>
          </td>
          <td><span class="badge badge-soft"><%= e.action %></span></td>
          <td class="small">
            <div class="text-muted"><%= e.targetType %></div>
            <div class="fw-semibold"><%= e.targetId %></div>
          </td>
          <td class="d-none d-md-table-cell small text-muted" style="max-width:420px; white-space:normal;">
            <%= typeof e.details === 'string' ? e.details : JSON.stringify(e.details || {}) %>
          </td>
        </tr>
      <% }) %>
      </tbody>
    </table>
  </div>
</div>
